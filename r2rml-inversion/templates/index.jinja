<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2RML Test Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">R2RML Test Interface</h1>
        <div class="row">
            <div class="col-md-6">
                <select id="testSelect" class="form-select mb-3">
                    <option value="">Select a test</option>
                    {% for test in tests %}
                    <option value="{{ test }}">{{ test }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <select id="dbSelect" class="form-select mb-3">
                    <option value="postgresql">PostgreSQL</option>
                    <option value="mysql">MySQL</option>
                </select>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col">
                <button onclick="runTest()" class="btn btn-primary">Run Test</button>
                <button onclick="viewMapping()" class="btn btn-secondary">View Mapping</button>
            </div>
        </div>
        <div id="mappingContent" class="mb-4" style="display: none;">
            <h2>R2RML Mapping</h2>
            <pre><code id="mappingCode"></code></pre>
        </div>
        <div id="results"></div>
    </div>

    <script>
        function runTest() {
            const testId = $('#testSelect').val();
            const dbSystem = $('#dbSelect').val();
            const resultsDiv = $('#results');
            resultsDiv.html('<p class="text-info">Running test...</p>');

            $.post('/run_test', {
                test_id: testId,
                database_system: dbSystem
            })
            .done(function(response) {
                if (response.status === 'success') {
                    let resultsHtml = '<h2>Test Results:</h2>';
                    resultsHtml += '<pre>' + JSON.stringify(response.results, null, 2) + '</pre>';
                    resultsDiv.html(resultsHtml);
                } else {
                    let errorHtml = '<h2 class="text-danger">Error:</h2>';
                    errorHtml += '<p>' + response.message + '</p>';
                    if (response.traceback) {
                        errorHtml += '<h3>Traceback:</h3>';
                        errorHtml += '<pre>' + response.traceback + '</pre>';
                    }
                    resultsDiv.html(errorHtml);
                }
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                resultsDiv.html('<p class="text-danger">Error: ' + textStatus + '</p>');
            });
        }

        function viewMapping() {
            const testId = $('#testSelect').val();
            if (!testId) {
                alert('Please select a test first.');
                return;
            }

            $.get('/get_mapping/' + testId)
            .done(function(response) {
                if (response.status === 'success') {
                    $('#mappingCode').text(response.content);
                    $('#mappingContent').show();
                } else {
                    alert('Error: ' + response.message);
                }
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                alert('Error: ' + textStatus);
            });
        }
    </script>
</body>
</html>